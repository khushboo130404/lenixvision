<!DOCTYPE html>
<html>
<head>
  <title>ESP32-CAM Vision System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    #videoFeed {
      width: 480px;
      max-width: 90%;
      height: auto;
      border-radius: 12px;
      border: 3px solid #ddd;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .btn {
      min-width: 160px;
    }
  </style>
</head>
<body class="p-3">
  <div class="container text-center">
    <h3 class="mb-4 fw-semibold">ESP32-CAM Live with YOLOv8 + Scene Description + OCR</h3>

    <!-- ESP32 URL input -->
    <div class="mb-3">
      <label for="esp32url" class="form-label">ESP32 Base URL:</label>
      <input id="esp32url" type="text" class="form-control text-center w-50 mx-auto" value="http://192.168.1.8">
      <button id="saveSource" class="btn btn-primary mt-2">Save Source</button>
      <p id="status" class="text-success mt-2"></p>
    </div>

    <!-- Live Video Feed -->
    <div class="card p-3 mb-4 shadow-sm">
      <h5 class="mb-2">Live Video</h5>
      <div class="d-flex justify-content-center">
        <img id="videoFeed" src="" alt="ESP32 Live Stream">
      </div>
    </div>

    <!-- Language Selection -->
    <div class="mb-3">
      <label for="languageSelect" class="form-label">Select Language:</label>
      <select id="languageSelect" class="form-select w-25 mx-auto">
        <option value="en">English</option>
        <option value="hi">Hindi</option>
      </select>
    </div>

    <!-- Control Buttons -->
    <div class="d-flex justify-content-center gap-3 flex-wrap">
      <button id="detectBtn" class="btn btn-success">Start Object Detection</button>
      <button id="sceneBtn" class="btn btn-info text-white">Scene Description</button>
      <button id="ocrBtn" class="btn btn-warning">Read Text</button>
    </div>

    <p id="output" class="mt-4 fw-bold fs-5 text-primary"></p>
  </div>

  <script>
    const videoFeed = document.getElementById("videoFeed");
    const output = document.getElementById("output");
    let detectionInterval = null;
    let isDetectionActive = false;

    // Save ESP32 source
    document.getElementById("saveSource").addEventListener("click", () => {
      const url = document.getElementById("esp32url").value;
      fetch("/set_source", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ base: url, use_stream: false })
      })
      .then(res => res.json())
      .then(() => {
        document.getElementById("status").innerText = "Source updated successfully!";
        videoFeed.src = "/video_feed";
      });
    });

    // YOLO object detection toggle
    document.getElementById("detectBtn").addEventListener("click", () => {
      if (!isDetectionActive) {
        fetch("/start_yolo")
          .then(res => res.json())
          .then(() => {
            isDetectionActive = true;
            document.getElementById("detectBtn").innerText = "Stop Object Detection";
            document.getElementById("detectBtn").classList.remove("btn-success");
            document.getElementById("detectBtn").classList.add("btn-danger");
            output.innerText = "YOLO object detection active. Polling for detections...";
            // Start polling for labels
            detectionInterval = setInterval(() => {
              fetch("/labels")
                .then(res => res.json())
                .then(data => {
                  if (data.labels && data.labels.trim() !== "") {
                    output.innerText = "Detected: " + data.labels;
                  }
                });
            }, 2000);
          });
      } else {
        isDetectionActive = false;
        document.getElementById("detectBtn").innerText = "Start Object Detection";
        document.getElementById("detectBtn").classList.remove("btn-danger");
        document.getElementById("detectBtn").classList.add("btn-success");
        output.innerText = "Object detection stopped.";
        if (detectionInterval) {
          clearInterval(detectionInterval);
          detectionInterval = null;
        }
      }
    });

    // Scene description
    document.getElementById("sceneBtn").addEventListener("click", () => {
      output.innerText = "Loading scene description...";
      fetch("/describe")
        .then(res => res.json())
        .then(data => output.innerText = "Scene: " + data.text);
    });

    // Language selection
    document.getElementById("languageSelect").addEventListener("change", (event) => {
      const selectedLanguage = event.target.value;
      fetch("/set_language", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ language: selectedLanguage })
      })
      .then(res => res.json())
      .then(data => {
        console.log("Language set to:", data.language);
      });
    });

    // OCR text reading
    document.getElementById("ocrBtn").addEventListener("click", () => {
      fetch("/read_text")
        .then(res => res.json())
        .then(data => output.innerText = "Text: " + data.text);
    });
  </script>
</body>
</html>
